name: Deploy to AlwaysData (SSH)

on:
  push:
    branches: ["main"]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.ALWAYSDATA_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H "ssh-govanalytics.alwaysdata.net" >> ~/.ssh/known_hosts

      - name: Deploy on server
        run: |
          ssh "govanalytics@$ssh-govanalytics.alwaysdata.net" <<'EOF'
            set -euo pipefail
            cd /home/govanalytics/ioea/ioea_kit

            git fetch --all
            git reset --hard origin/main

            npm ci
            npx prisma migrate deploy
            npx prisma generate
            npm run build

            curl -sS -X POST --basic --user "${ALWAYSDATA_API_KEY} account=govanalytics:" \
              "https://api.alwaysdata.com/v1/site/1001434/restart/"
          EOF
        env:
          ALWAYSDATA_API_KEY: ${{ secrets.ALWAYSDATA_API_KEY }}
