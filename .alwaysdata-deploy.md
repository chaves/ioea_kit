# AlwaysData Deployment Guide

## Initial Setup

### 1. Install Node.js on AlwaysData

1. Log into your AlwaysData account
2. Go to **Environment** → **Languages** → **Node.js**
3. Install Node.js (version 18 or higher recommended)
4. Note the Node.js path (usually `/home/[username]/nodejs/`)

### 2. Clone Repository

Via SSH:

```bash
cd ~/www
git clone https://github.com/chaves/ioea_kit.git
cd ioea_kit
```

### 3. Install Dependencies

```bash
npm install
npx prisma generate
```

### 4. Configure Environment Variables

Create `.env` file in the project root:

```bash
cp .env.example .env
nano .env
```

Set your database URL and email configuration:
```
DATABASE_URL="mysql://username:password@localhost:3306/ioea"

# Email Configuration (required for production)
SMTP_HOST="smtp.gmail.com"
SMTP_PORT="587"
SMTP_SECURE="false"
SMTP_USER="your-email@gmail.com"
SMTP_PASSWORD="your-app-password"
SMTP_FROM_EMAIL="ioea.coordinator@gmail.com"
SMTP_FROM_NAME="IOEA Team"
SMTP_REJECT_UNAUTHORIZED="true"
```

**Email Setup Notes:**
- For Gmail: Enable 2FA and use an [App Password](https://support.google.com/accounts/answer/185833)
- For other providers: Adjust SMTP_HOST, SMTP_PORT, and SMTP_SECURE accordingly
- Common ports: 587 (TLS), 465 (SSL), 25 (unencrypted, not recommended)

### 5. Build Application

```bash
npm run build
```

### 6. Set Up Process Manager

AlwaysData supports several process managers. Choose one:

#### Option A: Using AlwaysData's Scheduled Services

1. Go to **Environment** → **Scheduled services**
2. Create a new service:
   - **Name**: `ioea-kit`
   - **Command**: `node /home/[username]/www/ioea_kit/build/index.js`
   - **Working directory**: `/home/[username]/www/ioea_kit`
   - **Environment variables**: Load from `.env` file
   - **Start mode**: Automatic

#### Option B: Using PM2 (if available)

```bash
npm install -g pm2
pm2 start build/index.js --name ioea-kit
pm2 save
pm2 startup
```

### 7. Configure Web Server

1. Go to **Web** → **Sites**
2. Create or edit your site
3. Set **Type** to **Reverse proxy**
4. Set **Target** to `http://localhost:3000` (or your chosen port)
5. Configure SSL with Let's Encrypt

## Automatic Deployment

### Method 1: Git Post-Receive Hook (Recommended)

1. On AlwaysData server, create a git repository:

```bash
cd ~/www
git clone --bare https://github.com/chaves/ioea_kit.git ioea_kit.git
cd ioea_kit.git
```

2. Create post-receive hook:

```bash
cat > hooks/post-receive << 'EOF'
#!/bin/bash
cd ~/www/ioea_kit
git --git-dir=../ioea_kit.git --work-tree=. checkout -f main
~/www/ioea_kit/deploy.sh
EOF

chmod +x hooks/post-receive
```

3. Add AlwaysData repository as remote:

```bash
# On your local machine
git remote add alwaysdata ssh://[username]@ssh-[account].alwaysdata.net:22/~/www/ioea_kit.git
```

4. Deploy:

```bash
git push alwaysdata main
```

### Method 2: GitHub Webhook

1. Create a webhook endpoint script on AlwaysData:

```bash
cat > ~/www/webhook-deploy.sh << 'EOF'
#!/bin/bash
cd ~/www/ioea_kit
git pull origin main
~/www/ioea_kit/deploy.sh
EOF

chmod +x ~/www/webhook-deploy.sh
```

2. In AlwaysData, go to **Environment** → **Scheduled services**
3. Create a new service that runs the webhook script
4. In GitHub, go to **Settings** → **Webhooks** → **Add webhook**
5. Set **Payload URL** to your AlwaysData webhook endpoint
6. Set **Content type** to `application/json`
7. Set **Secret** (optional but recommended)
8. Select **Just the push event**

### Method 3: Simple Git Pull Script

Create a simple script that you can run manually or via cron:

```bash
cat > ~/www/ioea_kit/update.sh << 'EOF'
#!/bin/bash
cd ~/www/ioea_kit
git pull origin main
npm ci
npx prisma generate
npm run build
# Restart your service here
EOF

chmod +x ~/www/ioea_kit/update.sh
```

## Port Configuration

By default, SvelteKit with adapter-node runs on port 3000. You can change this:

1. Set environment variable: `PORT=3000`
2. Or modify `build/index.js` after build
3. Update AlwaysData reverse proxy to match

## Troubleshooting

### Check Logs

```bash
# If using AlwaysData scheduled service
# Check logs in AlwaysData dashboard → Environment → Scheduled services

# If using PM2
pm2 logs ioea-kit

# Application logs
tail -f ~/www/ioea_kit/logs/*.log
```

### Common Issues

1. **Port already in use**: Change PORT environment variable
2. **Database connection**: Verify DATABASE_URL in .env
3. **Build fails**: Check Node.js version (needs 18+)
4. **Permissions**: Ensure files are owned by your user

## Maintenance

- **Update dependencies**: `npm update`
- **Database migrations**: `npx prisma migrate deploy`
- **Restart service**: Via AlwaysData dashboard or process manager

